name: windows

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  VCPKG_COMMIT_ID: 688e57ffcb95380ba63e7e8a76e12fb674a7c4ef

jobs:
  build-and-test:
    runs-on: windows-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Cache vcpkg
      uses: actions/cache@v4
      with:
        path: C:/vcpkg
        key: vcpkg-${{ runner.os }}-${{ env.VCPKG_COMMIT_ID }}-${{ hashFiles('vcpkg.json') }}
        restore-keys: |
          vcpkg-${{ runner.os }}-${{ env.VCPKG_COMMIT_ID }}-
          vcpkg-${{ runner.os }}-
    
    - name: Install vcpkg
      shell: bash
      run: |
        if [ ! -d "C:/vcpkg" ]; then
          echo "Installing vcpkg..."
          git clone https://github.com/microsoft/vcpkg.git C:/vcpkg
          cd C:/vcpkg
          git checkout ${{ env.VCPKG_COMMIT_ID }}
          cmd.exe /c bootstrap-vcpkg.bat
        else
          echo "vcpkg already installed"
        fi
    
    - name: Install dependencies
      shell: bash
      run: |
        C:/vcpkg/vcpkg.exe install \
          --triplet x64-windows \
          --x-manifest-root=${{ github.workspace }} \
          --x-install-root=${{ github.workspace }}/vcpkg_installed
    
    - name: Configure CMake
      shell: bash
      run: |
        cmake -B build -S . \
          -G "Visual Studio 17 2022" \
          -A x64 \
          -DCMAKE_TOOLCHAIN_FILE=C:/vcpkg/scripts/buildsystems/vcpkg.cmake \
          -DBUILD_TESTS=ON \
          -DENABLE_SANITIZER=OFF \
          -DCMAKE_POLICY_DEFAULT_CMP0174=NEW
    
    - name: Build
      shell: bash
      run: |
        cmake --build build --config Release --parallel 4
    
    - name: Run tests
      shell: bash
      run: |
        cd build
        ctest --output-on-failure --timeout 30 -C Release

    - name: Run example (coro)
      timeout-minutes: 2
      shell: bash
      continue-on-error: true
      run: |
        [ -f "build/Release/example_coro.exe" ] && timeout 5 ./build/Release/example_coro.exe || echo "Executable not found"
    
    - name: Run example (https)
      timeout-minutes: 2
      shell: bash
      continue-on-error: true
      run: |
        [ -f "build/Release/example_https.exe" ] && timeout 5 ./build/Release/example_https.exe || echo "Executable not found"
    
    - name: Run example (keepalive)
      timeout-minutes: 2
      shell: bash
      continue-on-error: true
      run: |
        [ -f "build/Release/example_keepalive.exe" ] && timeout 5 ./build/Release/example_keepalive.exe || echo "Executable not found"
    
    - name: Run example (proxy)
      timeout-minutes: 2
      shell: bash
      continue-on-error: true
      run: |
        [ -f "build/Release/example_proxy.exe" ] && timeout 5 ./build/Release/example_proxy.exe || echo "Executable not found"
    
    - name: Run example (retry)
      timeout-minutes: 2
      shell: bash
      continue-on-error: true
      run: |
        [ -f "build/Release/example_retry.exe" ] && timeout 5 ./build/Release/example_retry.exe || echo "Executable not found"
    
    - name: Run example (sse)
      timeout-minutes: 2
      shell: bash
      continue-on-error: true
      run: |
        [ -f "build/Release/example_sse_coro.exe" ] && timeout 5 ./build/Release/example_sse_coro.exe || echo "Executable not found"
